<!-- 添加MD5库 -->
<script src="https://cdn.jsdelivr.net/npm/js-md5@0.7.3/src/md5.min.js"></script>

<!-- 自定义Gitalk配置脚本 -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // 确保加载顺序正确
    setTimeout(function() {
      // 检查Gitalk是否已加载
      if (typeof Gitalk === 'undefined') {
        console.error('Gitalk未加载，尝试手动加载');
        // 尝试手动加载Gitalk
        var script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.min.js';
        script.onload = initGitalk;
        document.head.appendChild(script);
        
        // 加载Gitalk CSS
        var link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = 'https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.min.css';
        document.head.appendChild(link);
      } else {
        initGitalk();
      }
    }, 1000);
    
    function initGitalk() {
      // 检查gitalk容器是否存在
      var gitalkContainer = document.getElementById('gitalk');
      if (!gitalkContainer) {
        console.error('未找到gitalk容器');
        return;
      }
      
      // 清空现有内容
      gitalkContainer.innerHTML = '';
      
      try {
        // 手动设置Gitalk配置
        var pathname = decodeURI(window.location.pathname);
        var gitalkOptions = {
          id: md5(pathname).substring(0, 49),  // 使用MD5确保ID长度合适
          owner: 'Jasion-han',  // 请确保这是您的GitHub用户名
          repo: 'walson-blog-comments',  // 确保这是存储评论的正确仓库
          clientID: 'Ov23liFcJ08RSapOllbY',  // 您的GitHub OAuth App client ID
          clientSecret: 'b56a83b238e49aba957fbe87f0890906ad79a4a2',  // 您的GitHub OAuth App client secret
          admin: ['Jasion-han'],  // 管理员名单
          createIssueManually: false,  // 自动创建issue
          distractionFreeMode: true,
          // 确保redirect_uri是完整的URL
          redirect_uri: window.location.origin + window.location.pathname
        };
        
        console.log('Gitalk配置:', gitalkOptions);
        
        // 创建Gitalk实例
        var gitalk = new Gitalk(gitalkOptions);
        
        // 渲染Gitalk评论
        gitalk.render('gitalk');
        
        // 监听DOM变化，修复输入和提交按钮
        var observer = new MutationObserver(function(mutations) {
          mutations.forEach(function(mutation) {
            if (mutation.addedNodes.length > 0) {
              // 修复错误消息
              var errorElements = document.querySelectorAll('.gt-error');
              if (errorElements.length > 0) {
                errorElements.forEach(function(element) {
                  if (element.textContent.includes('Not Found')) {
                    console.log('检测到Gitalk错误，尝试创建Issue');
                    element.style.display = 'none';
                    
                    // 自动点击创建Issue按钮
                    setTimeout(function() {
                      var createIssueBtn = document.querySelector('.gt-header-controls .gt-btn');
                      if (createIssueBtn) {
                        createIssueBtn.click();
                        console.log('自动点击创建Issue按钮');
                      }
                    }, 500);
                  }
                });
              }
              
              // 修复输入框
              fixTextareas();
              
              // 修复提交按钮
              fixSubmitButtons();
            }
          });
        });
        
        // 开始监听DOM变化
        observer.observe(gitalkContainer, { childList: true, subtree: true });
        
        // 修复输入框函数
        function fixTextareas() {
          var textareas = document.querySelectorAll('.gt-header-textarea');
          if (textareas.length === 0) return;
          
          textareas.forEach(function(textarea) {
            // 清除原有的样式限制
            textarea.style.pointerEvents = 'auto';
            textarea.style.userSelect = 'text';
            textarea.style.webkitUserSelect = 'text';
            textarea.style.caretColor = 'auto';
            textarea.style.cursor = 'text';
            
            // 移除原有事件监听器
            var newTextarea = textarea.cloneNode(true);
            textarea.parentNode.replaceChild(newTextarea, textarea);
            
            // 确保输入框可以获得和保持焦点
            newTextarea.addEventListener('click', function(e) {
              this.focus();
            });
            
            // 防止键盘事件被拦截
            newTextarea.addEventListener('keydown', function(e) {
              if (e.key === 'Enter' && e.ctrlKey) {
                e.stopPropagation();
                
                // 手动提交评论
                var submitBtn = document.querySelector('.gt-btn.gt-btn-public');
                if (submitBtn) submitBtn.click();
              }
            }, true);
          });
        }
        
        // 修复提交按钮函数
        function fixSubmitButtons() {
          var submitButtons = document.querySelectorAll('.gt-btn.gt-btn-public');
          if (submitButtons.length === 0) return;
          
          submitButtons.forEach(function(button) {
            // 克隆按钮以移除现有事件监听器
            var newButton = button.cloneNode(true);
            button.parentNode.replaceChild(newButton, button);
            
            // 确保按钮可点击
            newButton.style.pointerEvents = 'auto';
            newButton.style.cursor = 'pointer';
            
            // 添加点击事件
            newButton.addEventListener('click', function(e) {
              e.preventDefault();
              e.stopPropagation();
              
              // 获取评论内容
              var textarea = document.querySelector('.gt-header-textarea');
              if (!textarea) return;
              
              var content = textarea.value.trim();
              if (!content) return;
              
              console.log('提交评论:', content);
              
              // 触发表单提交
              var form = document.querySelector('.gt-header-comment');
              if (form) {
                var submitEvent = new Event('submit', {bubbles: true, cancelable: true});
                form.dispatchEvent(submitEvent);
              }
            });
          });
        }
      } catch (error) {
        console.error('Gitalk初始化失败:', error);
        
        // 显示错误信息给用户
        gitalkContainer.innerHTML = '<div class="gt-error" style="color: red; padding: 10px; text-align: center;">' + 
                                   '评论系统加载失败，请刷新页面重试。错误信息: ' + error.message + '</div>';
      }
    }
    
    // 添加全局错误处理
    window.addEventListener('error', function(event) {
      if (event.message && (
          event.message.includes('ResizeObserver') || 
          event.message.includes('Gitalk') ||
          event.message.includes('axios')
        )) {
        console.log('已拦截非关键错误:', event.message);
        event.stopPropagation();
        event.preventDefault();
        return false;
      }
    }, true);
  });
</script>