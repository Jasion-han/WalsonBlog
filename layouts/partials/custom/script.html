<!-- 添加MD5库 -->
<script src="https://cdn.jsdelivr.net/npm/js-md5@0.7.3/src/md5.min.js"></script>

<!-- 自定义Gitalk配置脚本 -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  // 等待DOM完全加载
  setTimeout(function() {
    // 1. 确保依赖库加载
    if (typeof Gitalk === 'undefined' || typeof md5 === 'undefined') {
      console.error('Gitalk或md5未加载，尝试重新加载');
      loadDependencies();
      return;
    }
    
    initGitalk();
  }, 1000);
  
  // 加载依赖库函数
  function loadDependencies() {
    // 加载Gitalk
    if (typeof Gitalk === 'undefined') {
      var gitalkScript = document.createElement('script');
      gitalkScript.src = 'https://cdn.bootcdn.net/ajax/libs/gitalk/1.7.2/gitalk.min.js';
      gitalkScript.onload = function() {
        console.log('Gitalk加载完成');
        if (typeof md5 !== 'undefined') initGitalk();
      };
      document.head.appendChild(gitalkScript);
      
      var gitalkCss = document.createElement('link');
      gitalkCss.rel = 'stylesheet';
      gitalkCss.href = 'https://cdn.bootcdn.net/ajax/libs/gitalk/1.7.2/gitalk.min.css';
      document.head.appendChild(gitalkCss);
    }
    
    // 加载MD5
    if (typeof md5 === 'undefined') {
      var md5Script = document.createElement('script');
      md5Script.src = 'https://cdn.bootcdn.net/ajax/libs/js-md5/0.7.3/md5.min.js';
      md5Script.onload = function() {
        console.log('MD5加载完成');
        if (typeof Gitalk !== 'undefined') initGitalk();
      };
      document.head.appendChild(md5Script);
    }
  }
  
  // 初始化Gitalk
  function initGitalk() {
    var gitalkContainer = document.getElementById('gitalk');
    if (!gitalkContainer) {
      console.error('找不到gitalk容器，无法初始化评论系统');
      return;
    }
    
    // 清空容器
    gitalkContainer.innerHTML = '';
    
    try {
      // 创建Gitalk配置
      var pathname = decodeURI(window.location.pathname);
      var gitalkOptions = {
        id: md5(pathname).substring(0, 49),
        owner: 'Jasion-han',
        repo: 'walson-blog-comments',
        clientID: 'Ov23liFcJ08RSapOllbY',
        clientSecret: 'b56a83b238e49aba957fbe87f0890906ad79a4a2',
        admin: ['Jasion-han'],
        createIssueManually: false,
        distractionFreeMode: true,
        // 添加proxy选项以解决跨域问题
        proxy: 'https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token'
      };
      
      console.log('Gitalk配置:', gitalkOptions);
      
      // 实例化并渲染
      var gitalk = new Gitalk(gitalkOptions);
      
      // 绕过问题：手动尝试创建issue
      gitalk.options.createIssueManually = true;
      
      // 渲染评论区
      gitalk.render('gitalk');
      
      // 监听DOM变化，修复评论区问题
      applyFixesWhenReady(gitalkContainer, gitalk);
    } catch (error) {
      console.error('Gitalk初始化出错:', error);
      gitalkContainer.innerHTML = '<div style="color:red;text-align:center;padding:10px;">' + 
                                 '评论系统加载失败: ' + error.message + '</div>';
    }
  }
  
  // 监听DOM变化，在Gitalk元素就绪时应用修复
  function applyFixesWhenReady(container, gitalk) {
    var observer = new MutationObserver(function(mutations) {
      // 检查是否有错误信息或评论输入框
      var hasCommentsLoaded = document.querySelector('.gt-header-textarea') !== null;
      var hasError = document.querySelector('.gt-error') !== null;
      
      if (hasError) {
        handleGitalkErrors(gitalk);
      }
      
      if (hasCommentsLoaded) {
        fixGitalkInputs();
      }
    });
    
    observer.observe(container, { childList: true, subtree: true });
  }
  
  // 处理Gitalk错误
  function handleGitalkErrors(gitalk) {
    var errors = document.querySelectorAll('.gt-error');
    errors.forEach(function(error) {
      console.log('检测到错误:', error.textContent);
      
      if (error.textContent.includes('Not Found')) {
        // 隐藏错误消息
        error.style.display = 'none';
        
        // 尝试创建Issue
        console.log('检测到Not Found错误，尝试自动创建Issue');
        
        // 直接点击创建Issue按钮
        setTimeout(function() {
          var createIssueBtn = document.querySelector('.gt-header-controls .gt-btn');
          if (createIssueBtn) {
            console.log('找到创建Issue按钮，点击中...');
            createIssueBtn.click();
          } else {
            console.log('未找到创建Issue按钮');
            
            // 如果找不到按钮，尝试通过API直接创建
            if (gitalk && typeof gitalk.options !== 'undefined') {
              console.log('尝试使用Gitalk实例创建Issue');
              // 创建特定Issue
              gitalk.createIssue({
                title: document.title,
                body: '这是由系统自动创建的Issue，用于存储评论。\n\n页面地址: ' + window.location.href
              });
            }
          }
        }, 1000);
      } else if (error.textContent.includes('Network Error') || 
                 error.textContent.includes('Request failed') ||
                 error.textContent.includes('ajax error')) {
        // 网络错误处理
        error.style.display = 'none';
        console.log('检测到网络错误，尝试刷新Gitalk');
        
        // 延迟后尝试重新初始化
        setTimeout(initGitalk, 3000);
      }
    });
  }
  
  // 完全替换评论区输入框实现
  function fixGitalkInputs() {
    // 如果已经修复过，不重复处理
    if (document.querySelector('[data-gitalk-fixed="true"]')) {
      return;
    }
    
    // 创建标记，避免重复修复
    var fixMarker = document.createElement('div');
    fixMarker.setAttribute('data-gitalk-fixed', 'true');
    fixMarker.style.display = 'none';
    document.body.appendChild(fixMarker);
    
    // 1. 彻底替换输入框
    var mainTextarea = document.querySelector('.gt-header-textarea');
    if (mainTextarea) {
      var parent = mainTextarea.parentNode;
      if (parent) {
        // 创建完全新的textarea
        var customTextarea = document.createElement('textarea');
        
        // 复制属性
        customTextarea.className = mainTextarea.className + ' custom-textarea';
        customTextarea.placeholder = mainTextarea.placeholder || '说点什么...';
        
        // 设置必要的样式，确保光标可见
        customTextarea.style.width = '100%';
        customTextarea.style.minHeight = '120px';
        customTextarea.style.padding = '12px';
        customTextarea.style.boxSizing = 'border-box';
        customTextarea.style.border = '1px solid #e9e9e9';
        customTextarea.style.borderRadius = '4px';
        customTextarea.style.resize = 'vertical';
        customTextarea.style.outline = 'none';
        customTextarea.style.caretColor = 'auto';
        customTextarea.style.color = '#333';
        customTextarea.style.background = '#ffffff';
        customTextarea.style.fontSize = '14px';
        customTextarea.style.lineHeight = '1.6';
        
        // 替换原始textarea
        parent.innerHTML = '';
        parent.appendChild(customTextarea);
        
        // 保存引用
        window.gitalkCustomTextarea = customTextarea;
        
        // 添加焦点状态样式
        customTextarea.addEventListener('focus', function() {
          this.style.border = '1px solid #6190e8';
        });
        
        customTextarea.addEventListener('blur', function() {
          this.style.border = '1px solid #e9e9e9';
        });
        
        // 监听输入事件，更新提交按钮状态
        customTextarea.addEventListener('input', function() {
          var submitBtn = document.querySelector('.gt-btn-public');
          if (submitBtn) {
            submitBtn.disabled = this.value.trim() === '';
          }
        });
        
        // 修复Ctrl+Enter提交
        customTextarea.addEventListener('keydown', function(e) {
          if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
            e.preventDefault();
            var submitBtn = document.querySelector('.gt-btn-public');
            if (submitBtn && !submitBtn.disabled) {
              submitBtn.click();
            }
          }
        });
        
        // 自动获取焦点
        setTimeout(function() {
          customTextarea.focus();
        }, 200);
      }
    }
    
    // 2. 修复提交按钮
    var submitBtn = document.querySelector('.gt-btn-public');
    if (submitBtn) {
      var newBtn = document.createElement('button');
      
      // 复制内容和属性
      newBtn.innerHTML = submitBtn.innerHTML;
      newBtn.className = submitBtn.className;
      newBtn.disabled = submitBtn.disabled;
      
      // 确保可点击
      newBtn.style.cursor = 'pointer';
      
      // 替换按钮
      submitBtn.parentNode.replaceChild(newBtn, submitBtn);
      
      // 点击处理
      newBtn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        // 获取用户输入
        var textarea = window.gitalkCustomTextarea;
        if (!textarea || textarea.value.trim() === '') {
          console.log('评论内容为空，不提交');
          return;
        }
        
        // 提交评论
        submitComment(textarea.value);
      });
    }
    
    // 更新回复按钮处理
    setTimeout(function() {
      var replyBtns = document.querySelectorAll('.gt-comment-reply');
      if (replyBtns.length > 0) {
        replyBtns.forEach(function(btn) {
          btn.addEventListener('click', function(e) {
            if (window.gitalkCustomTextarea) {
              var username = this.closest('.gt-comment-content').querySelector('.gt-comment-username').textContent;
              window.gitalkCustomTextarea.value = '@' + username + ' ';
              window.gitalkCustomTextarea.focus();
            }
          });
        });
      }
    }, 1000);
  }
  
  // 提交评论函数
  function submitComment(content) {
    console.log('准备提交评论:', content);
    
    // 找到表单并模拟提交
    var form = document.querySelector('.gt-header-comment');
    if (form) {
      // 1. 找到原始textarea并设置值
      var originalTextarea = form.querySelector('textarea:not(.custom-textarea)');
      if (originalTextarea) {
        // 这个textarea可能是隐藏的，先设置值
        originalTextarea.value = content;
        
        // 触发input事件，确保Gitalk内部状态更新
        var inputEvent = new Event('input', {bubbles: true});
        originalTextarea.dispatchEvent(inputEvent);
      }
      
      // 2. 提交表单
      var submitEvent = new Event('submit', {bubbles: true, cancelable: true});
      form.dispatchEvent(submitEvent);
      
      // 3. 监控结果
      setTimeout(function() {
        var errors = document.querySelectorAll('.gt-error');
        if (errors.length > 0) {
          console.log('评论提交出错:', errors[0].textContent);
        } else {
          console.log('评论可能已成功提交');
          // 清空输入框
          if (window.gitalkCustomTextarea) {
            window.gitalkCustomTextarea.value = '';
          }
        }
      }, 2000);
    } else {
      console.error('找不到评论表单，无法提交');
    }
  }
  
  // 全局错误处理
  window.addEventListener('error', function(event) {
    if (event.message && (
        event.message.includes('ResizeObserver') || 
        event.message.includes('Gitalk') ||
        event.message.includes('axios') ||
        event.message.includes('GitHub')
      )) {
      console.log('拦截了非关键错误:', event.message);
      event.preventDefault();
      return false;
    }
  }, true);
});
</script>