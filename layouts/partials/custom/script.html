<!-- 添加MD5库 -->
<script src="https://cdn.jsdelivr.net/npm/js-md5@0.7.3/src/md5.min.js"></script>

<!-- 自定义Gitalk配置脚本 -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // 修复btoa函数，使其支持Unicode字符
    window.originalBtoa = window.btoa;
    window.btoa = function(str) {
      try {
        return window.originalBtoa(str);
      } catch (e) {
        // 如果原生btoa失败，使用自定义的Base64编码
        return window.originalBtoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, function(match, p1) {
          return String.fromCharCode('0x' + p1);
        }));
      }
    };
    
    // 等待Gitalk初始化
    setTimeout(function() {
      if (window.Gitalk && window.commentConfig && window.commentConfig.gitalk) {
        // 使用MD5哈希处理URL作为id，确保长度不超过50
        var pathname = decodeURI(window.location.pathname);
        window.commentConfig.gitalk.id = md5(pathname).substring(0, 49);
        
        // 确保admin是数组
        if (!Array.isArray(window.commentConfig.gitalk.admin)) {
          window.commentConfig.gitalk.admin = [window.commentConfig.gitalk.owner];
        }
        
        // 设置正确的授权回调URL
        window.commentConfig.gitalk.redirect_uri = window.location.origin;
        
        // 移除body参数，避免编码问题
        delete window.commentConfig.gitalk.body;
        
        // 添加调试信息
        console.log('Gitalk配置:', window.commentConfig.gitalk);
        
        // 初始化Gitalk
        var gitalk = new Gitalk(window.commentConfig.gitalk);
        gitalk.render('gitalk');
      } else {
        console.error('Gitalk初始化失败，可能是配置或库未加载');
      }
    }, 1000); // 增加等待时间，确保所有资源加载完成
  });
</script>